#!/usr/bin/env bash
set -eo pipefail

execute_test() {
  if [[ -d "${1}" ]]; then
    (
      cd "${1}"
      # Get the exercise name from the directory
      local exercise_name
      exercise_name=$(echo "$1" | tr '-' '_')

      echo "Running tests for ${exercise_name}"

      # Copy the examples with the correct name for the exercise
      if [[ -f "./.meta/example.zig" ]]; then
        mv ./.meta/example.zig "${exercise_name}".zig
        # No building required, just test it
        if [ -L "${HOME}/bin/zig" ]; then
          # Zig track repo symlinks zig to this location
          "${HOME}/bin/zig" test "test_${exercise_name}.zig"
        else
          # Otherwise zig should be on your $PATH
          zig test "test_${exercise_name}.zig"
        fi
        printf '\n'
      else
        printf '%s\n' "${exercise_name} missing contents, skipping test..."
      fi
    )
  fi
}

main() {
  # Move to the root directory of the repo so you can run this script from anywhere
  local script_dir
  script_dir="$(cd "$(dirname "$0")" >/dev/null 2>&1 && pwd)"
  cd "${script_dir}"/..

  # Clear up any previous run
  rm -rf build

  if [[ -d "exercises/practice" ]]; then
    cp -r exercises/practice build
  else
    printf '%s\n' "The exercises/practice folder is missing..." >&2
    exit 1
  fi

  (
    cd build/

    # Allow specifying which tests to run as arguments
    if [[ $# -gt 0 ]]; then
      local exercises=("$@")
      for exercise in "${exercises[@]}"; do
        if [[ ! -d "${exercise}" ]]; then
          printf '%s\n' "The specified exercise '${1}' does not exist" >&2
          exit 1
        fi
      done
    else
      local exercises=(*)
    fi

    for exercise in "${exercises[@]}"; do
      execute_test "${exercise}"
    done
  )

  # Clean up duplicate exercises
  rm -rf build
}

main "$@"
